# =============================================
# ACE Invoice API - Docker Compose Starter
# =============================================
# This compose file sets up SQL Server with automatic database initialization.
#
# QUICK START:
#   1. Copy your schema SQL file to this folder as 'init.sql'
#   2. Run: docker compose up -d
#   3. Uncomment and configure the API section below for your platform
#
# The database will be automatically created and seeded when you run compose up.
# =============================================

services:
  # =============================================
  # SQL SERVER DATABASE
  # =============================================
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    environment:
      - ACCEPT_EULA=Y
      - SA_PASSWORD=${SA_PASSWORD:-YourStrong@Passw0rd}
    ports:
      - "1433:1433"
    volumes:
      - sqlserver_data:/var/opt/mssql
    healthcheck:
      test: /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "$${SA_PASSWORD:-YourStrong@Passw0rd}" -C -Q "SELECT 1" || exit 1
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  # =============================================
  # DATABASE INITIALIZATION
  # =============================================
  # Runs init.sql automatically after SQL Server is healthy.
  # Place your schema + seed data in init.sql in this folder.
  db-init:
    image: mcr.microsoft.com/mssql-tools:latest
    depends_on:
      sqlserver:
        condition: service_healthy
    volumes:
      - ./init.sql:/init.sql:ro
    environment:
      - SA_PASSWORD=${SA_PASSWORD:-YourStrong@Passw0rd}
    command: >
      /bin/bash -c "
        echo 'Waiting for SQL Server to be ready...';
        sleep 5;
        echo 'Running database initialization...';
        /opt/mssql-tools/bin/sqlcmd -S sqlserver -U sa -P \"$${SA_PASSWORD}\" -C -i /init.sql;
        echo 'Database initialization complete!';
      "

  # =============================================
  # YOUR API SERVICE
  # =============================================
  # Uncomment ONE of the following sections based on your platform.
  # Make sure your Dockerfile is in the correct location.

  # ---------------------------------------------
  # OPTION A: C# / .NET API
  # ---------------------------------------------
  # Uncomment this section if using C#/.NET
  # Expects: Dockerfile in ./src/YourApiProject/
  #
  # api:
  #   build:
  #     context: .
  #     dockerfile: src/YourApiProject/Dockerfile
  #   ports:
  #     - "${API_PORT:-5001}:8080"
  #   environment:
  #     - ConnectionStrings__DefaultConnection=Server=sqlserver,1433;Database=AceInvoice;User Id=sa;Password=${SA_PASSWORD:-YourStrong@Passw0rd};TrustServerCertificate=True;
  #     - ApiKey=${API_KEY:-your-api-key-here}
  #   depends_on:
  #     db-init:
  #       condition: service_completed_successfully

  # ---------------------------------------------
  # OPTION B: Node.js API
  # ---------------------------------------------
  # Uncomment this section if using Node.js
  # Expects: Dockerfile in the root folder
  #
  # api:
  #   build: .
  #   ports:
  #     - "${API_PORT:-5001}:8080"
  #   environment:
  #     - DB_SERVER=sqlserver
  #     - DB_PORT=1433
  #     - DB_USER=sa
  #     - DB_PASSWORD=${SA_PASSWORD:-YourStrong@Passw0rd}
  #     - DB_NAME=AceInvoice
  #     - API_KEY=${API_KEY:-your-api-key-here}
  #   depends_on:
  #     db-init:
  #       condition: service_completed_successfully

# =============================================
# ENVIRONMENT VARIABLES (optional overrides)
# =============================================
# You can override these defaults by setting environment variables:
#   SA_PASSWORD  - SQL Server SA password (default: YourStrong@Passw0rd)
#   API_KEY      - Your API authentication key
#   API_PORT     - Port to expose the API (default: 5001)
#
# Example:
#   SA_PASSWORD=MySecret123! API_PORT=8080 docker compose up -d

volumes:
  sqlserver_data:
